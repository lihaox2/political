<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.bayee.political.mapper.AlarmTalkMapper" >
  <resultMap id="BaseResultMap" type="com.bayee.political.domain.AlarmTalk" >
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="title" property="title" jdbcType="VARCHAR" />
    <result column="talk_type" property="talkType" jdbcType="INTEGER" />
    <result column="police_id" property="policeId" jdbcType="VARCHAR" />
    <result column="police_name" property="policeName" jdbcType="VARCHAR" />
    <result column="department_id" property="departmentId" jdbcType="INTEGER" />
    <result column="department_name" property="departmentName" jdbcType="VARCHAR" />
    <result column="start_time" property="startTime" jdbcType="TIMESTAMP" />
    <result column="end_time" property="endTime" jdbcType="TIMESTAMP" />
    <result column="content" property="content" jdbcType="VARCHAR" />
    <result column="message" property="message" jdbcType="VARCHAR" />
    <result column="feedback" property="feedback" jdbcType="VARCHAR" />
    <result column="reason" property="reason" jdbcType="VARCHAR" />
    <result column="host_id" property="hostId" jdbcType="VARCHAR" />
    <result column="host_name" property="hostName" jdbcType="VARCHAR" />
    <result column="position_name" property="positionName" jdbcType="VARCHAR" />
    <result column="status" property="status" jdbcType="INTEGER" />
    <result column="is_receive" property="isReceive" jdbcType="INTEGER" />
    <result column="creation_date" property="creationDate" jdbcType="TIMESTAMP" />
    <result column="update_date" property="updateDate" jdbcType="TIMESTAMP" />
  </resultMap>
  <resultMap id="TalkStatistics" type="com.bayee.political.domain.AlarmTalkStatistics" >
    <result column="completionRate" property="completionRate" jdbcType="VARCHAR" />
    <result column="unfinishedRate" property="unfinishedRate" jdbcType="VARCHAR" />
  </resultMap>
  <resultMap id="TalkPoliceNum" type="com.bayee.political.domain.AlarmTalkPoliceNum" >
    <result column="totalNum" property="totalNum" jdbcType="INTEGER" />
    <result column="addNum" property="addNum" jdbcType="INTEGER" />
    <result column="buckleNum" property="buckleNum" jdbcType="INTEGER" />
  </resultMap>
  <resultMap id="alarmLeaderStatistics" type="com.bayee.political.domain.AlarmLeaderStatistics" >
    <result column="totalNum" property="totalNum" jdbcType="INTEGER" />
    <result column="proportion" property="proportion" jdbcType="DOUBLE" />
    <result column="receiveNum" property="receiveNum" jdbcType="INTEGER" />
    <result column="overNum" property="overNum" jdbcType="INTEGER" />
  </resultMap>
   <resultMap id="calculationChart" type="com.bayee.political.domain.CalculationChart" >
    <id column="id" property="id" />
    <result column="name" property="name" />
    <result column="num" property="num" />
  </resultMap>
  <sql id="Base_Column_List" >
    id, title, talk_type, police_id, department_id, start_time, end_time, content,message,
    feedback,reason, host_id, 
    status,is_receive, creation_date, update_date
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    select 
    <include refid="Base_Column_List" />
    from alarm_talk
    where id = #{id,jdbcType=INTEGER}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer" >
    delete from alarm_talk
    where id = #{id,jdbcType=INTEGER}
  </delete>
  <!-- 约谈记录新增 -->
  <insert id="alarmTalkCreat" keyColumn="id" keyProperty="id" parameterType="com.bayee.political.domain.AlarmTalk" useGeneratedKeys="true">
    insert into alarm_talk (title, talk_type, 
      police_id, department_id, start_time, 
      end_time, content,message,feedback, reason,host_id, 
      status,is_receive, creation_date, update_date
      )
    values (#{title,jdbcType=VARCHAR}, #{talkType,jdbcType=INTEGER}, 
      #{policeId,jdbcType=VARCHAR}, #{departmentId,jdbcType=INTEGER}, #{startTime,jdbcType=TIMESTAMP}, 
      #{endTime,jdbcType=TIMESTAMP}, #{content,jdbcType=VARCHAR},#{message,jdbcType=VARCHAR}, 
      #{feedback,jdbcType=VARCHAR},#{reason,jdbcType=VARCHAR}, #{hostId,jdbcType=VARCHAR}, 
      #{status,jdbcType=INTEGER}, #{isReceive,jdbcType=INTEGER},
      #{creationDate,jdbcType=TIMESTAMP}, #{updateDate,jdbcType=TIMESTAMP}
      )
  </insert>
  <!-- 约谈记录修改 -->
  <update id="alarmTalkUpdate" parameterType="com.bayee.political.domain.AlarmTalk" >
    update alarm_talk
    <set >
      <if test="title != null" >
        title = #{title,jdbcType=VARCHAR},
      </if>
      <if test="talkType != null" >
        talk_type = #{talkType,jdbcType=INTEGER},
      </if>
      <if test="policeId != null" >
        police_id = #{policeId,jdbcType=VARCHAR},
      </if>
      <if test="departmentId != null" >
        department_id = #{departmentId,jdbcType=INTEGER},
      </if>
      <if test="startTime != null" >
        start_time = #{startTime,jdbcType=TIMESTAMP},
      </if>
      <if test="endTime != null" >
        end_time = #{endTime,jdbcType=TIMESTAMP},
      </if>
      <if test="content != null" >
        content = #{content,jdbcType=VARCHAR},
      </if>
      <if test="message != null" >
        message = #{message,jdbcType=VARCHAR},
      </if>
      <if test="feedback != null" >
        feedback = #{feedback,jdbcType=VARCHAR},
      </if>
       <if test="reason != null" >
        reason = #{reason,jdbcType=VARCHAR},
      </if>
      <if test="hostId != null" >
        host_id = #{hostId,jdbcType=VARCHAR},
      </if>
      <if test="status != null" >
        status = #{status,jdbcType=INTEGER},
      </if>
      <if test="isReceive != null" >
        is_receive = #{isReceive,jdbcType=INTEGER},
      </if>
      <if test="creationDate != null" >
        creation_date = #{creationDate,jdbcType=TIMESTAMP},
      </if>
      <if test="updateDate != null" >
        update_date = #{updateDate,jdbcType=TIMESTAMP},
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.bayee.political.domain.AlarmTalk" >
    update alarm_talk
    set title = #{title,jdbcType=VARCHAR},
      talk_type = #{talkType,jdbcType=INTEGER},
      police_id = #{policeId,jdbcType=VARCHAR},
      department_id = #{departmentId,jdbcType=INTEGER},
      start_time = #{startTime,jdbcType=TIMESTAMP},
      end_time = #{endTime,jdbcType=TIMESTAMP},
      content = #{content,jdbcType=VARCHAR},
      message = #{message,jdbcType=VARCHAR},
      feedback = #{feedback,jdbcType=VARCHAR},
      reason = #{reason,jdbcType=VARCHAR},
      host_id = #{hostId,jdbcType=VARCHAR},
      status = #{status,jdbcType=INTEGER},
      is_receive = #{isReceive,jdbcType=INTEGER},
      creation_date = #{creationDate,jdbcType=TIMESTAMP},
      update_date = #{updateDate,jdbcType=TIMESTAMP}
    where id = #{id,jdbcType=INTEGER}
  </update>
  <!--约谈记录详情查询(后台) -->
  <select id="alarmTalkItem" parameterType="com.bayee.political.domain.AlarmTalk" resultMap="BaseResultMap">
select a.*,b.name as police_name,b.head_image as headImage,c.name as department_name,
d.name as host_name,d.head_image as hostHeadImage from alarm_talk a
left join user b on b.police_id=a.police_id
left join department c on c.id=a.department_id
left join user d on d.police_id=a.host_id
where a.id = #{id}
</select>
  <!--约谈近期列表查询(api) -->
  <select id="alarmTalkLastList" parameterType="com.bayee.political.domain.AlarmTalk" resultMap="BaseResultMap">
select a.*,b.name as police_name,b.head_image as headImage,c.name as department_name
from alarm_talk a
left join user b on b.police_id=a.police_id
left join department c on c.id=a.department_id
where a.host_id=#{hostId,jdbcType=VARCHAR} and a.is_receive=2
     <if test="dateTime != null and dateTime !=''">
        and DATE_FORMAT(a.start_time,'%Y-%m-%d') = #{dateTime} 
      </if> 
order by a.start_time limit 3
</select>
  <!--约谈消息列表查询(api) -->
  <select id="alarmTalkNewsList" parameterType="com.bayee.political.domain.AlarmTalk" resultMap="BaseResultMap">
select a.*,b.name as police_name,b.head_image as headImage,c.name as department_name
from alarm_talk a
left join user b on b.police_id=a.police_id
left join department c on c.id=a.department_id
where a.host_id=#{hostId,jdbcType=VARCHAR} and a.is_receive!=0 
order by a.update_date desc limit 2
</select>
  <!--约谈完成率，未完成率查询 -->
  <select id="alarmTalkRateItem" parameterType="com.bayee.political.domain.AlarmTalkStatistics" resultMap="TalkStatistics">
select round(a.anum/(a.anum+b.bnum),2)*100 as completionRate,
(100-round(a.anum/(a.anum+b.bnum),2)*100) as unfinishedRate from
(select count(*) as anum from alarm_talk where host_id=#{hostId,jdbcType=VARCHAR} 
and status=5 
      <if test="dateTime != null and dateTime !=''">
        and DATE_FORMAT(start_time,'%Y-%m') = #{dateTime} 
      </if>) a
join(select count(*) as bnum from alarm_talk where host_id=#{hostId,jdbcType=VARCHAR} 
and status!=5
     <if test="dateTime != null and dateTime !=''">
        and DATE_FORMAT(start_time,'%Y-%m') = #{dateTime} 
      </if>) b
</select>
  <!--约谈完成人数查询 -->
  <select id="talkPoliceNumItem" parameterType="com.bayee.political.domain.AlarmTalkPoliceNum" resultMap="TalkPoliceNum">
select * from(select count(*) as totalNum from alarm_talk 
where host_id=#{hostId,jdbcType=VARCHAR} and status=5
     <if test="dateTime != null and dateTime !=''">
        and DATE_FORMAT(start_time,'%Y-%m') = #{dateTime} 
      </if>) a
join(select count(*) as addNum from alarm_talk where host_id=#{hostId,jdbcType=VARCHAR} 
and status=5 and talk_type=1
      <if test="dateTime != null and dateTime !=''">
        and DATE_FORMAT(start_time,'%Y-%m') = #{dateTime} 
      </if>) b
join(select count(*) as buckleNum from alarm_talk where host_id=#{hostId,jdbcType=VARCHAR} 
and status=5 and talk_type=2
      <if test="dateTime != null and dateTime !=''">
        and DATE_FORMAT(start_time,'%Y-%m') = #{dateTime} 
      </if>) c
</select>
  <!--约谈未完成人数查询 -->
  <select id="noTalkPoliceNumItem" parameterType="com.bayee.political.domain.AlarmTalkPoliceNum" resultMap="TalkPoliceNum">
select * from(select count(*) as totalNum from alarm_talk where host_id=#{hostId,jdbcType=VARCHAR} and status!=5
<if test="dateTime != null and dateTime !=''">
        and DATE_FORMAT(start_time,'%Y-%m') = #{dateTime} 
      </if>) a
join(select count(*) as addNum from alarm_talk where host_id=#{hostId,jdbcType=VARCHAR} 
and status!=5 and talk_type=1
<if test="dateTime != null and dateTime !=''">
        and DATE_FORMAT(start_time,'%Y-%m') = #{dateTime} 
      </if>) b
join(select count(*) as buckleNum from alarm_talk where host_id=#{hostId,jdbcType=VARCHAR} 
and status!=5 and talk_type=2
<if test="dateTime != null and dateTime !=''">
        and DATE_FORMAT(start_time,'%Y-%m') = #{dateTime} 
      </if>) c
</select>
  <!--个人谈话预约列表查询 -->
  <select id="alarmTalkPersonalList" parameterType="com.bayee.political.domain.AlarmTalk" resultMap="BaseResultMap">
select a.*,b.name as host_name,b.head_image as headImage,c.name as department_name,d.position_name
from alarm_talk a
left join user b on b.police_id=a.host_id
left join department c on c.id=b.department_id
left join police_position d on d.id=b.position_id
where a.police_id=#{policeId} and a.is_receive=0
order by a.start_time
</select>
  <!--局领导约谈人数统计 -->
  <select id="alarmLeaderTalkStatistics" parameterType="com.bayee.political.domain.AlarmLeaderStatistics" resultMap="alarmLeaderStatistics">
select * from(select count(*) as totalNum from alarm_talk where host_id=#{policeId} 
and DATE_FORMAT(creation_date,'%Y%m')=DATE_FORMAT(CURDATE(),'%Y%m')) a
join
(select count(*) as overNum from alarm_talk where host_id=#{policeId} 
and DATE_FORMAT(creation_date,'%Y%m')=DATE_FORMAT(CURDATE(),'%Y%m')
and status=5) b
join(select count(*) as receiveNum from alarm_talk where host_id=#{policeId} 
and DATE_FORMAT(creation_date,'%Y%m')=DATE_FORMAT(CURDATE(),'%Y%m')
and status=2) c
</select>
  <!--局领导约谈数量累计统计-->
  <select id="alarmLeaderTalkItem" parameterType="com.bayee.political.domain.AlarmLeaderStatistics" resultMap="alarmLeaderStatistics">
select * from(select count(*) as totalNum from alarm_talk where host_id=#{policeId} ) a
join
(select count(*) as overNum from alarm_talk where host_id=#{policeId} 
and DATE_FORMAT(creation_date,'%Y%m')=DATE_FORMAT(CURDATE(),'%Y%m')) b
</select>
  <!--局领导约谈事项查询-->
  <select id="alarmLeaderTalkList" parameterType="com.bayee.political.domain.AlarmTalk" resultMap="BaseResultMap">
select a.*,b.name as police_name,b.head_image as headImage,c.name as department_name
from alarm_talk a
left join user b on b.police_id=a.police_id
left join department c on c.id=a.department_id
where a.host_id=#{policeId,jdbcType=VARCHAR}
order by a.start_time asc
</select>
<!--各月已约谈人数查询 -->
  <select id="alarmTalkMonthNumChart" parameterType="com.bayee.political.domain.CalculationChart" resultMap="calculationChart" >
select ifnull(b.num,0) as num,a.police_month as name from alarm_police_month a
left join(select count(*) as num,
REPLACE(LTRIM(REPLACE(DATE_FORMAT(start_time,'%m'),'0',' ')),' ','0') as months 
from alarm_talk 
where host_id=#{hostId} and status=5
and DATE_FORMAT(start_time,'%Y')=DATE_FORMAT(CURDATE(),'%Y')
GROUP BY DATE_FORMAT(start_time,'%m')) b on b.months=a.id
where a.id&lt;=REPLACE(LTRIM(REPLACE(DATE_FORMAT(CURDATE(),'%m'),'0',' ')),' ','0')
order by a.id
</select>
<!-- 获得约谈列表/根据条件查询 -->
<select id="getAlarmTalk" resultMap="BaseResultMap">
select a.id,b.`name` as police_name,a.police_id,c.`name` as department_name,a.title,
a.start_time,a.end_time,a.`status` from alarm_talk a left join user b on a.police_id = b.police_id
left join department c on a.department_id = c.id
where 1 = 1
<if test="alrmTalk.startTime!=null">
and date(a.start_time) = #{alrmTalk.startTime}
</if>
<if test="alrmTalk.departmentId!=null and alrmTalk.departmentId!=''">
and a.department_id = #{alrmTalk.departmentId}
</if>
<if test="keywords!=null and keywords!=''">
and (a.police_id = #{keywords} or b.`name` = #{keywords} or a.title = #{keywords} or a.content = #{keywords})
</if>
limit #{pageSize},10
</select>

<!-- 获得约谈列表数量 -->
<select id="getAlarmTalkCount" resultType="java.lang.Integer">
select count(*) as count from alarm_talk a left join user b on a.police_id = b.police_id
left join department c on a.department_id = c.id
where 1 = 1
<if test="alrmTalk.startTime!=null">
and date(a.start_time) = #{alrmTalk.startTime}
</if>
<if test="alrmTalk.departmentId!=null and alrmTalk.departmentId!=''">
and a.department_id = #{alrmTalk.departmentId}
</if>
<if test="keywords!=null and keywords!=''">
and (a.police_id = #{keywords} or b.`name` = #{keywords} or a.title = #{keywords} or a.content = #{keywords})
</if>
</select>

</mapper>